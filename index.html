<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>A to Z Packers & Movers — Staff Control + Attendance (v2, inline-login)</title>
  <meta name="color-scheme" content="light only">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f7f8fa; --card:#fff; --ink:#121417; --muted:#667085;
      --brand:#14532D; /* deep green primary */
      --ok:#16a34a; --warn:#f59e0b;
      --bad:#B91C1C; /* red sign-out */
      --shadow:0 10px 28px rgba(16,24,40,.12);
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:var(--bg);color:var(--ink)}
    a{color:var(--brand);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid #e5e7eb}
    .brand{display:flex;align-items:center;gap:10px;padding:12px 16px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#ff4d4f,#22c55e,#facc15);box-shadow:var(--shadow)}
    h1,h2,h3{font-family:Poppins,Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink)}
    h1{font-size:28px;margin:0}
    h2{font-size:22px;margin:0}
    h3{font-size:16px;margin:0}
    nav.tabs{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:8px 16px}
    nav.tabs button{
      padding:14px 16px;
      border:none;
      border-radius:16px;
      background:var(--card);
      box-shadow:var(--shadow);
      font-weight:700;
      font-size:16px;
    }
    nav.tabs button.active{outline:2px solid var(--brand)}
    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (min-width:900px){.cards{grid-template-columns:repeat(4,1fr)}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
    .stat{font-size:22px;font-weight:800}
    .row{display:grid;gap:12px}
    @media (min-width:900px){.row{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:16px 18px;
      font-size:18px;
      border-radius:16px;
      border:1px solid #e5e7eb;
    }
    input::placeholder,textarea::placeholder{color:#9AA4B2}
    input:focus,select:focus,textarea:focus{outline:2px solid #D1FAE5;border-color:#86EFAC}
    nav.tabs button:focus{outline:2px solid var(--brand)}

    /* Buttons redesigned: big rounded, bold */
    .btn{
      background:var(--brand);
      padding:16px 22px;
      border:none;
      border-radius:18px;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      color:#fff;
      cursor:pointer;
      box-shadow:var(--shadow);
      transition:background .2s;
    }
    .btn:hover{background:#166534}
    .btn.secondary{background:#0B1220;color:#fff}
    .btn.ghost{background:#fff;color:#0B1220;border:1px solid #E5E7EB}
    .btn.warn{background:var(--warn);color:#111}
    .btn.bad{background:var(--bad);color:#fff} /* red sign out */
    .btn.mini{font-size:14px;padding:10px 14px;border-radius:12px}

    .floating-bar{
      position:fixed;bottom:20px;right:20px;
      display:flex;gap:10px;
      background:#fff;
      border-radius:18px;
      padding:10px;
      box-shadow:var(--shadow);
      z-index:60;
    }

    .tag{display:inline-block;padding:4px 8px;background:#EEF2FF;color:#1E3A8A;
      border-radius:999px;font-size:12px;font-weight:600}
    .status-active{background:#E8F5E9;color:#166534}
    .status-leave{background:#FEF3C7;color:#92400E}
    .error{color:#b91c1c;font-size:12px}
    .footer{padding:16px;color:var(--muted);text-align:center}
    .login{max-width:440px;margin:32px auto}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;
      align-items:center;justify-content:center;padding:16px;z-index:80}
    .modal.show{display:flex}
    .modal .sheet{background:#fff;border-radius:16px;box-shadow:var(--shadow);
      width:100%;max-width:520px;padding:16px}
    .modal h3{margin:0 0 8px 0}
  </style>
</head>
<body>
  <header>
    <div class="brand container">
      <div class="logo"></div>
      <h1>A to Z Packers & Movers — Staff Control + Attendance</h1>
      <div class="right muted mini" id="loginStatus"></div>
    </div>
    <nav class="tabs container">
      <button class="tabBtn active" data-tab="dashboard" disabled>Dashboard</button>
      <button class="tabBtn" data-tab="entry" disabled>Entry</button>
      <button class="tabBtn" data-tab="staff" disabled>Staff Master</button>
      <button class="tabBtn" data-tab="reports" disabled>Reports</button>
      <button class="tabBtn" data-tab="settings" disabled>Settings</button>
    </nav>
  </header>

  <main class="container">
    <!-- LOGIN PANEL -->
    <section id="loginGate" class="login card">
      <h2 style="margin:0 0 8px 0;">Admin Login</h2>
      <p class="muted mini" style="margin-top:0">Restricted access.</p>
      <div class="row">
        <div class="card">
          <label>Login ID</label>
          <input id="loginId" placeholder="admin" autocomplete="username">
          <label>Password</label>
          <input id="loginPw" type="password" placeholder="••••••••" autocomplete="current-password">
          <!-- INLINE, SELF-CONTAINED LOGIN TOOLBAR -->
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="btnLogin" type="button"
              onclick="(function(){
                var id=(document.getElementById('loginId').value||'').trim();
                var pw=(document.getElementById('loginPw').value||'').trim();
                var msg=document.getElementById('loginMsg');
                if(id==='admin' && pw==='AZ@2025'){
                  try{ localStorage.setItem('adminLoggedIn','1'); sessionStorage.setItem('adminLoggedIn','1'); }catch(e){}
                  var gate=document.getElementById('loginGate'); if(gate) gate.classList.add('hidden');
                  try{ document.querySelectorAll('.tabs button').forEach(function(b){ b.disabled=false; }); }catch(e){}
                  try{ document.getElementById('loginStatus').textContent='Admin: Logged in'; }catch(e){}
                  // Show dashboard
                  ['dashboard','entry','staff','reports','settings'].forEach(function(id){
                    var el=document.getElementById(id); if(el) el.classList.add('hidden');
                  });
                  var dash=document.getElementById('dashboard'); if(dash) dash.classList.remove('hidden');
                  try{
                    document.querySelectorAll('.tabBtn').forEach(function(b){ b.classList.remove('active'); });
                    document.querySelector('.tabBtn[data-tab="dashboard"]').classList.add('active');
                  }catch(e){}
                  if(msg) msg.textContent=' Logged in';
                }else{
                  if(msg) msg.textContent=' Invalid ID or password';
                }
              })();">Login</button>

            <button class="btn ghost" id="btnBypass" type="button"
              onclick="(function(){
                try{ localStorage.setItem('adminLoggedIn','1'); sessionStorage.setItem('adminLoggedIn','1'); }catch(e){}
                var gate=document.getElementById('loginGate'); if(gate) gate.classList.add('hidden');
                try{ document.getElementById('loginStatus').textContent='Admin: Logged in'; }catch(e){}
                try{ document.querySelectorAll('.tabs button').forEach(function(b){ b.disabled=false; }); }catch(e){}
                ['dashboard','entry','staff','reports','settings'].forEach(function(id){
                  var el=document.getElementById(id); if(el) el.classList.add('hidden');
                });
                var dash=document.getElementById('dashboard'); if(dash) dash.classList.remove('hidden');
                try{
                  document.querySelectorAll('.tabBtn').forEach(function(b){ b.classList.remove('active'); });
                  document.querySelector('.tabBtn[data-tab="dashboard"]').classList.add('active');
                }catch(e){}
                var m=document.getElementById('loginMsg'); if(m) m.textContent=' Bypassed (dev)';
              })();">Bypass</button>

            <div id="loginMsg" class="muted mini"></div>
          </div>
          <p class="mini muted">Default: <b>admin</b> / <b>AZ@2025</b></p>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section">
      <div class="cards">
        <div class="card"><h3>Today's Attendance</h3><div class="stat" id="statAttendance">0 P / 0 A / 0 L</div></div>
        <div class="card"><h3>On-Leave (Checked-Out)</h3><div class="stat" id="statOnLeave">0</div></div>
        <div class="card"><h3>Overdue Returns</h3><div class="stat" id="statOverdue">0</div></div>
        <div class="card"><h3>Penalties Today ()</h3><div class="stat" id="statPenalties">0</div></div>
      </div>

      <div class="row section">
        <div class="card">
          <div class="toolbar">
            <h3 style="margin:0;color:var(--ink)">Latest Entries</h3>
            <div class="right toolbar">
              <input id="filterDate" type="date">
              <select id="filterStaff"><option value="">All staff</option></select>
              <button class="btn ghost" id="btnClearFilters">Clear</button>
            </div>
          </div>
          <div style="overflow:auto">
            <table id="entriesTable"><thead>
              <tr><th>Date</th><th>Staff</th><th>Attendance</th><th>Advance</th><th>Penalty</th><th>Promise</th><th>Perm</th><th>Actions</th></tr>
            </thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <div class="toolbar"><h3 style="margin:0;color:var(--ink)">Track Record (select staff)</h3>
            <select id="graphStaffSelect" style="max-width:260px"></select></div>
          <canvas id="trackChart" height="280"></canvas>
        </div>
      </div>
    </section>
    <!-- ENTRY -->
    <section id="entry" class="section hidden">
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0;color:var(--ink)">Unified Entry Form</h3><span class="pill">IST timezone</span>
          <div class="right muted mini" id="entryBlockMsg"></div>
        </div>

        <div class="row">
          <div><label>Date</label><input id="fDate" type="date"></div>
          <div><label>Staff</label><select id="fStaff"></select></div>
        </div>

        <div class="row">
          <div>
            <label>Attendance</label>
            <select id="fAttendance">
              <option value="Present">Present</option>
              <option value="Absent">Absent</option>
              <option value="Late">Late</option>
            </select>
          </div>
          <div id="lateTimeWrap">
            <label>Late Time (HH:MM)</label>
            <input id="fLateTime" type="time" step="60">
          </div>
        </div>

        <div class="row">
          <div><label>Advance ()</label><input id="fAdvance" type="number" min="0" step="0.01" placeholder="0"></div>
          <div><label>Penalty ()</label><input id="fPenalty" type="number" min="0" step="0.01" placeholder="0"></div>
        </div>

        <div class="row">
          <div>
            <label>Penalty Reason (required if penalty &gt; 0)</label>
            <input id="fPenaltyReason" placeholder="Reason for penalty">
          </div>
          <div>
            <label>Promising</label>
            <select id="fPromise">
              <option value="3|By Talk">By Talk (3)</option>
              <option value="2|By SMS">By SMS (2)</option>
              <option value="1|By God Promise">By God Promise (1)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="card">
            <label>Discipline Checklist</label>
            <div class="toolbar">
              <label><input type="checkbox" id="chkDiscipline"> Discipline</label>
              <label><input type="checkbox" id="chkUniform"> Uniform</label>
              <label><input type="checkbox" id="chkObey"> Obey Rules</label>
              <label><input type="checkbox" id="chkPunctual"> Punctual</label>
            </div>
          </div>
          <div>
            <label>Special Instruction</label>
            <textarea id="fNote" placeholder="Any instruction..."></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Boss Permission?</label>
            <select id="fPerm"><option value="Yes">Yes</option><option value="No">No</option></select>
          </div>
          <div class="muted mini">Leave is handled from <b>Staff Master</b> using “Leave Check-Out / Return Check-In”.</div>
        </div>

        <div class="floating-bar">
          <button class="btn" id="btnSave">Save</button>
          <button class="btn secondary" id="btnSaveNotify">Save & Notify</button>
          <button class="btn ghost" id="btnNotifyOnly">Notify Only</button>
          <button class="btn warn" id="btnReset">Reset</button>
          <div class="mini muted right">WhatsApp opens per action (allow pop-ups).</div>
        </div>
      </div>
    </section>
    <!-- STAFF MASTER -->
    <section id="staff" class="section hidden">
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">Staff Master</h3>
          <div class="right toolbar">
            <input id="staffSearch" placeholder="Search name/role/mobile">
            <button class="btn" id="btnAddStaff">Add Staff</button>
          </div>
        </div>
        <div style="overflow:auto">
          <table id="staffTable">
            <thead>
              <tr><th>Name</th><th>Role</th><th>Mobile</th><th>Status</th><th>Leave</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="section hidden">
      <div class="row">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Leave & Penalty Report</h3>
          <div class="toolbar">
            <input id="repFrom" type="date" title="From (Promised Return Date)">
            <input id="repTo" type="date" title="To (Promised Return Date)">
            <select id="repStatus">
              <option value="">All Status</option>
              <option value="Active">Active (Checked-In)</option>
              <option value="OnLeave">On-Leave (Checked-Out)</option>
            </select>
            <select id="repBreach">
              <option value="">Breach: All</option>
              <option value="Y">Breach: Yes</option>
              <option value="N">Breach: No</option>
            </select>
            <select id="repPriority">
              <option value="">Priority: All</option>
              <option>High</option><option>Med</option><option>Low</option>
            </select>
            <label class="mini"><input type="checkbox" id="repOverdue"> Overdue Only</label>
            <button class="btn ghost" id="btnRunReport">Run</button>
            <button class="btn" id="btnExportCSV">Export CSV (Excel)</button>
          </div>
          <div style="overflow:auto">
            <table id="reportTable">
              <thead><tr>
                <th>Name</th><th>Role</th><th>Mobile</th><th>Status</th>
                <th>LeaveStartAt</th><th>PromisedReturnDate</th><th>ReturnedAt</th>
                <th>PromiseBreach</th><th>PenaltyAmount</th><th>Priority</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Audit Log</h3>
          <div id="auditLog" class="mini" style="max-height:340px;overflow:auto"></div>
        </div>
      </div>
    </section>
    <!-- SETTINGS -->
    <section id="settings" class="section hidden">
      <div class="card">
        <h3 style="margin-top:0">WhatsApp & Session</h3>
        <div class="toolbar">
          <label><input type="checkbox" id="autoWA"> Auto-send WhatsApp on Leave/Return/Penalty</label>
        </div>
        <p class="mini muted">Official wa.me links with URL-encoded, compact messages (). Timezone: IST.</p>
      </div>

      <div class="card">
        <h3>Data Backup</h3>
        <div class="toolbar">
          <button class="btn" id="btnExport">Download Backup (.json)</button>
          <input type="file" id="fileImport" accept=".json">
          <button class="btn ghost" id="btnImport">Import & Merge</button>
        </div>
        <p class="mini muted">Long-term storage via IndexedDB (fallback to localStorage).</p>
      </div>

      <div class="card">
        <h3>Admin Session</h3>
        <div class="toolbar"><button class="btn ghost" id="btnForceLogout">Force Logout</button></div>
      </div>
    </section>

    <!-- MODALS -->
    <section id="modalLeaveOut" class="modal"><div class="sheet">
      <h3> Leave Check-Out</h3>
      <div class="mini muted" id="leaveOutWho"></div>
      <label>LeaveStartAt (IST)</label><input id="leaveStartAt" type="datetime-local">
      <label>Promised Return Date</label><input id="promisedReturn" type="date">
      <label>Reason</label><input id="leaveReason" placeholder="Short reason">
      <div id="leaveErr" class="error"></div>
      <div class="toolbar" style="margin-top:10px">
        <button class="btn" id="btnLeaveSave">Save & Mark On-Leave</button>
        <button class="btn ghost" onclick="closeModal('modalLeaveOut')">Cancel</button>
      </div>
    </div></section>

    <section id="modalReturnIn" class="modal"><div class="sheet">
      <h3> Return Check-In</h3>
      <div class="mini muted" id="returnWho"></div>
      <label>ReturnedAt (IST)</label><input id="returnedAt" type="datetime-local">
      <div id="returnErr" class="error"></div>
      <div class="toolbar" style="margin-top:10px">
        <button class="btn" id="btnReturnSave">Save Return</button>
        <button class="btn ghost" onclick="closeModal('modalReturnIn')">Cancel</button>
      </div>
    </div></section>

    <section id="modalPenalty" class="modal"><div class="sheet">
      <h3> Penalty — Promise not honored</h3>
      <div class="mini muted" id="penaltyWho"></div>
      <label>Amount</label>
      <select id="penaltyAmountSel">
        <option value="500">500</option><option value="1000">1000</option>
        <option value="2000">2000</option><option value="3000">3000</option>
        <option value="5000">5000</option><option value="custom">Custom Amount…</option>
        <option value="full">Full Salary Deduction</option>
      </select>
      <div id="customAmountWrap" class="hidden">
        <label>Custom Amount ()</label><input id="penaltyCustom" type="number" min="0" step="0.01" placeholder="0">
      </div>
      <label>Priority</label>
      <select id="penaltyPriority"><option>High</option><option selected>Med</option><option>Low</option></select>
      <div class="mini muted">Reason: <b>Promise not honored</b></div>
      <div id="penaltyErr" class="error"></div>
      <div class="toolbar" style="margin-top:10px">
        <button class="btn" id="btnPenaltySave">Apply Penalty</button>
        <button class="btn ghost" onclick="closeModal('modalPenalty')">Cancel</button>
      </div>
    </div></section>

    <footer class="footer">© <span id="yearNow"></span> A to Z Packers & Movers • 24×7 • IST</footer>

    <!-- SCRIPT starts -->
    <script>
      // ========================= CONFIG =========================
      const ADMIN_ID='admin', ADMIN_PW='AZ@2025', BOSS_E164='+9193388888550', IST_TZ='Asia/Kolkata';

      // ========================= UTIL =========================
      const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
      const nowIST = ()=> new Date(new Date().toLocaleString('en-US',{timeZone:IST_TZ}));
      const todayStr = ()=> nowIST().toLocaleDateString('en-CA',{timeZone:IST_TZ});
      const toIST = d => new Date(new Date(d).toLocaleString('en-US',{timeZone:IST_TZ}));
      const dtLocalValue = d => { const z=toIST(d); const pad=n=>String(n).padStart(2,'0'); return `${z.getFullYear()}-${pad(z.getMonth()+1)}-${pad(z.getDate())}T${pad(z.getHours())}:${pad(z.getMinutes())}`; };
      const uuid = ()=> (crypto?.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2));
      const sum = arr=>arr.reduce((a,b)=>a+Number(b||0),0);

      function sanitizeMobile(raw){
        let p=(''+(raw||'')).trim().replace(/[^\d+]/g,'');
        if(p.startsWith('00')) p='+'+p.slice(2);
        if(p.startsWith('0')) p='+91'+p.slice(1);
        if(p.startsWith('91') && p.length===12) p='+'+p;
        if(!p.startsWith('+')) p='+'+p;
        if(!/^\+?\d{10,13}$/.test(p)) throw new Error('Invalid mobile: must be 10–13 digits');
        if(!/^\+91\d{10}$/.test(p)) console.warn('Non-Indian E.164 pattern; proceeding');
        return p;
      }
      function waLink(e164, text){
        const digits=(''+e164).replace(/\D/g,'');
        const msg=(text||'').replace(/\s+\n/g,'\n').replace(/\n{2,}/g,'\n').trim();
        return `https://wa.me/${digits}?text=${encodeURIComponent(msg)}`;
      }
      function diffDH(startISO, endISO){
        const s=toIST(startISO), e=toIST(endISO);
        const ms=Math.max(0, e - s);
        const d=Math.floor(ms/(24*3600*1000));
        const h=Math.floor((ms - d*24*3600*1000)/(3600*1000));
        return {d,h};
      }

      // ========================= DB (IDB + fallback) =========================
      const DB_NAME='az_staff_control_v2';
      let db, idbSupported=('indexedDB' in window);
      function idbOpen(){
        return new Promise((resolve,reject)=>{
          if(!idbSupported){ resolve(null); return; }
          const req=indexedDB.open(DB_NAME,2);
          req.onupgradeneeded=e=>{
            const db=e.target.result;
            if(!db.objectStoreNames.contains('staff')){
              const staff=db.createObjectStore('staff',{keyPath:'id'});
              staff.createIndex('by_status','status',{unique:false});
              staff.createIndex('by_mobile','mobile',{unique:false});
            }
            if(!db.objectStoreNames.contains('entries')){
              const entries=db.createObjectStore('entries',{keyPath:'id'});
              entries.createIndex('by_staff','staffId',{unique:false});
              entries.createIndex('by_date','dateISO',{unique:false});
            }
            if(!db.objectStoreNames.contains('audits')){
              const audit=db.createObjectStore('audits',{keyPath:'id'});
              audit.createIndex('by_ts','ts',{unique:false});
            }
            if(!db.objectStoreNames.contains('leaves')){
              const leaves=db.createObjectStore('leaves',{keyPath:'id'});
              leaves.createIndex('by_staff','staffId',{unique:false});
              leaves.createIndex('by_promised','promisedReturnDate',{unique:false});
              leaves.createIndex('by_open','returnedAt',{unique:false});
            }
            if(!db.objectStoreNames.contains('penalties')){
              const pens=db.createObjectStore('penalties',{keyPath:'id'});
              pens.createIndex('by_staff','staffId',{unique:false});
              pens.createIndex('by_ts','appliedAt',{unique:false});
            }
          };
          req.onsuccess=e=>resolve(e.target.result);
          req.onerror=e=>reject(e.target.error);
        });
      }
      function tx(store,mode='readonly'){ return db.transaction(store,mode).objectStore(store) }
      function idbGetAll(store){ return new Promise((res,rej)=>{ const r=tx(store).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); })}
      function idbPut(store,obj){ return new Promise((res,rej)=>{ const r=tx(store,'readwrite').put(obj); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); })}
      function idbDel(store,id){ return new Promise((res,rej)=>{ const r=tx(store,'readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }}
      // Fallback to localStorage
      function lsGet(k){ return JSON.parse(localStorage.getItem(k)||'[]') }
      function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
      async function storageGetAll(store){ if(db) return await idbGetAll(store); return lsGet(store); }
      async function storagePut(store,obj){ if(db) return await idbPut(store,obj); const bag=lsGet(store); const i=bag.findIndex(x=>x.id===obj.id); if(i>=0) bag[i]=obj; else bag.push(obj); lsSet(store,bag); return obj.id; }
      async function storageDel(store,id){ if(db) return await idbDel(store,id); const bag=lsGet(store).filter(x=>x.id!==id); lsSet(store,bag); }
      async function addAudit(type, detail, oldVal=null, newVal=null){
        const rec={id:uuid(), type, detail, oldVal, newVal, ts:new Date().toISOString()};
        await storagePut('audits', rec); renderAudit();
      }

      // ========================= SESSION HELPERS =========================
      function isLogged(){
        try {
          return localStorage.getItem('adminLoggedIn')==='1' || sessionStorage.getItem('adminLoggedIn')==='1' || window.__memLogged===true;
        } catch(e){ return window.__memLogged===true; }
      }
      function setLogged(v){
        try{
          localStorage.setItem('adminLoggedIn', v?'1':'0');
          sessionStorage.setItem('adminLoggedIn', v?'1':'0');
        }catch(e){}
        window.__memLogged=!!v;
      }
      function getAutoWA(){ return localStorage.getItem('autoWA')==='1' }
      function setAutoWA(v){ localStorage.setItem('autoWA', v?'1':'0'); const t=$('#autoWA'); if(t) t.checked=v; }

      // ========================= SEED =========================
      async function seedIfNeeded(){
        const staff=await storageGetAll('staff');
        if(staff.length===0){
          const s1={id:uuid(), name:'Ajay Kumar', role:'Driver', mobile:'+919700000001', status:'Active'};
          const s2={id:uuid(), name:'Kaviraj', role:'Worker', mobile:'+919700000002', status:'Active'};
          const s3={id:uuid(), name:'Saroj', role:'Worker', mobile:'+919700000003', status:'Active'};
          await storagePut('staff', s1); await storagePut('staff', s2); await storagePut('staff', s3);
          await addAudit('seed', 'Seeded 3 staff');
        }
      }

      // ========================= RENDER HELPERS =========================
      async function refreshAll(){
        await renderStaffTable();
        await renderEntryFilters();
        await renderEntriesTable();
        await renderDashboardStats();
        await renderGraphStaffSelect();
        await renderAudit();
      }

      function setActiveTab(tabId){
        $$('.tabBtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tabId));
        ['dashboard','entry','staff','reports','settings'].forEach(id=>{
          $('#'+id).classList.toggle('hidden', id!==tabId);
        });
        if(tabId==='entry') fillFormDefaults();
      }
      function openModal(id){ $('#'+id).classList.add('show'); }
      function closeModal(id){
        $('#'+id).classList.remove('show');
        const errs=['leaveErr','returnErr','penaltyErr'];
        errs.forEach(k=>{ const el=$('#'+k); if(el) el.textContent=''; });
      }

      // ========================= STAFF MASTER =========================
      let currentLeaveStaffId=null, currentReturnLeaveId=null, pendingPenaltyCtx=null;

      async function renderStaffTable(){
        const tbody=$('#staffTable tbody');
        const q=($('#staffSearch').value||'').toLowerCase().trim();
        let staff=await storageGetAll('staff');
        staff.sort((a,b)=> a.name.localeCompare(b.name));
        if(q){ staff=staff.filter(s=> (s.name+s.role+s.mobile).toLowerCase().includes(q)); }

        tbody.innerHTML = staff.map(s=>{
          const st = s.status==='OnLeave' ? '<span class="tag status-leave">On-Leave (Checked-Out)</span>' :
                    s.status==='Active'   ? '<span class="tag status-active">Active (Checked-In)</span>' :
                                             '<span class="tag">Inactive</span>';
          const leaveBtn = s.status==='OnLeave'
            ? `<button class="btn secondary mini" onclick="openReturnModal('${s.id}')">Return Check-In</button>`
            : `<button class="btn mini" onclick="openLeaveModal('${s.id}')">Leave Check-Out</button>`;
          return `<tr>
            <td>${s.name}</td><td>${s.role||'-'}</td><td>${s.mobile||'-'}</td><td>${st}</td>
            <td>${leaveBtn}</td>
            <td class="toolbar">
              <button class="btn ghost mini" onclick="editStaff('${s.id}')">Edit</button>
              <button class="btn warn mini" onclick="toggleStaff('${s.id}')">${s.status==='Active'?'Deactivate':'Activate'}</button>
              <button class="btn bad mini" onclick="deleteStaff('${s.id}')">Delete</button>
            </td>
          </tr>`;
        }).join('') || '<tr><td colspan="6" class="muted">No staff yet.</td></tr>';

        await renderEntryStaffSelects();
      }

      async function checkDuplicateMobile(mobile, excludeId=null){
        const staff=await storageGetAll('staff');
        const found=staff.find(s=> s.mobile===mobile && s.id!==excludeId);
        if(found){ alert(`Mobile already linked to ${found.name}.`); return true; }
        return false;
      }

      async function editStaff(id){
        const s=(await storageGetAll('staff')).find(x=>x.id===id); if(!s) return;
        const name=prompt('Name', s.name); if(!name) return;
        const role=prompt('Role', s.role||''); if(role===null) return;
        let mobileRaw=prompt('Mobile (+91XXXXXXXXXX)', s.mobile||'')||s.mobile;
        try{
          const mobile=sanitizeMobile(mobileRaw);
          if(await checkDuplicateMobile(mobile, s.id)) return;
          const old={...s};
          s.name=name; s.role=role; s.mobile=mobile;
          await storagePut('staff', s);
          await addAudit('staff.update', `Updated ${s.name}`, old, s);
        }catch(e){ alert(e.message); return; }
        refreshAll();
      }

      async function toggleStaff(id){
        const s=(await storageGetAll('staff')).find(x=>x.id===id); if(!s) return;
        const old={...s};
        s.status = s.status==='Active' ? 'Inactive':'Active';
        await storagePut('staff', s);
        await addAudit('staff.status', `${s.name}  ${s.status}`, old, s);
        refreshAll();
      }

      async function deleteStaff(id){
        const staff=await storageGetAll('staff');
        const s=staff.find(x=>x.id===id); if(!s) return;
        const entries=await storageGetAll('entries');
        const leaves=await storageGetAll('leaves');
        if(entries.some(e=>e.staffId===id) || leaves.some(l=>l.staffId===id)){
          alert('Cannot delete: this staff has existing records. You can deactivate instead.');
          return;
        }
        if(confirm('Delete '+s.name+' permanently?')){
          await storageDel('staff', id);
          await addAudit('staff.delete', 'Deleted '+s.name);
          refreshAll();
        }
      }

      function openLeaveModal(staffId){
        currentLeaveStaffId=staffId;
        const sNow = new Date();
        $('#leaveStartAt').value = dtLocalValue(sNow);
        $('#promisedReturn').value = todayStr();
        $('#leaveOutWho').textContent = 'Mark On-Leave for selected staff (IST)';
        openModal('modalLeaveOut');
      }

      function openReturnModal(staffId){
        currentLeaveStaffId=staffId;
        currentReturnLeaveId=null;
        $('#returnedAt').value = dtLocalValue(new Date());
        $('#returnWho').textContent='Mark Return Check-In (IST)';
        openModal('modalReturnIn');
      }

      function openPenaltyModal(staffId, leaveId){
        pendingPenaltyCtx={staffId, leaveId};
        $('#customAmountWrap').classList.add('hidden');
        $('#penaltyAmountSel').value='500';
        $('#penaltyPriority').value='Med';
        $('#penaltyWho').textContent='Apply penalty for promise not honored.';
        openModal('modalPenalty');
      }

      $('#penaltyAmountSel')?.addEventListener('change', function(){
        $('#customAmountWrap').classList.toggle('hidden', this.value!=='custom');
      });

      async function leaveSave(){
        const start = $('#leaveStartAt').value;
        const promised = $('#promisedReturn').value;
        const reason = ($('#leaveReason').value||'').trim();
        if(!currentLeaveStaffId){ $('#leaveErr').textContent='Unknown staff.'; return; }
        if(!start || !promised){ $('#leaveErr').textContent='Start and Promised Return are required.'; return; }

        const rec = {
          id:uuid(), staffId:currentLeaveStaffId,
          leaveStartAt:new Date(start).toISOString(),
          promisedReturnDate: promised,
          reason, returnedAt:null, breach:null, penalty:0, priority:'Med'
        };
        await storagePut('leaves', rec);

        const staff=(await storageGetAll('staff')).find(s=>s.id===currentLeaveStaffId);
        if(staff){ staff.status='OnLeave'; await storagePut('staff', staff); }

        await addAudit('leave.out', `Leave OUT for staff ${currentLeaveStaffId}`, null, rec);

        if(getAutoWA()){
          try{
            const url = waLink(BOSS_E164,
              ` LEAVE OUT\n ${staff?.name||'Staff'}\n Start: ${new Date(rec.leaveStartAt).toLocaleString('en-IN')}\n Promise Return: ${rec.promisedReturnDate}\n Reason: ${reason||'-'}`);
            window.open(url, '_blank');
          }catch(_){}
        }
        closeModal('modalLeaveOut');
        refreshAll();
      }
      $('#btnLeaveSave')?.addEventListener('click', leaveSave);

      async function returnSave(){
        const returned = $('#returnedAt').value;
        if(!currentLeaveStaffId){ $('#returnErr').textContent='Unknown staff.'; return; }
        if(!returned){ $('#returnErr').textContent='ReturnedAt required.'; return; }

        // find open leave
        let leaves=await storageGetAll('leaves');
        const open = leaves.find(l=> l.staffId===currentLeaveStaffId && !l.returnedAt);
        if(!open){ $('#returnErr').textContent='No open leave for this staff.'; return; }

        open.returnedAt = new Date(returned).toISOString();

        // breach?
        const promised = new Date(open.promisedReturnDate+'T23:59:59');
        const ret = new Date(open.returnedAt);
        open.breach = ret > promised ? 'Y':'N';

        await storagePut('leaves', open);

        // update staff status
        const staff=(await storageGetAll('staff')).find(s=>s.id===currentLeaveStaffId);
        if(staff){ staff.status='Active'; await storagePut('staff', staff); }

        await addAudit('leave.return', `Return IN for staff ${currentLeaveStaffId}`, null, open);

        if(open.breach==='Y'){
          // open penalty UI
          openPenaltyModal(currentLeaveStaffId, open.id);
        }else{
          if(getAutoWA()){
            try{
              const url = waLink(BOSS_E164,
                ` RETURN IN\n ${staff?.name||'Staff'}\n Returned: ${new Date(open.returnedAt).toLocaleString('en-IN')}\n Promised: ${open.promisedReturnDate}\n Breach: NO`);
              window.open(url, '_blank');
            }catch(_){}
          }
          closeModal('modalReturnIn');
          refreshAll();
        }
      }
      $('#btnReturnSave')?.addEventListener('click', returnSave);

      async function penaltySave(){
        if(!pendingPenaltyCtx){ $('#penaltyErr').textContent='No context.'; return; }
        const sel=$('#penaltyAmountSel').value;
        let amount=0;
        if(sel==='custom'){
          amount=Number($('#penaltyCustom').value||0);
        }else if(sel==='full'){
          amount=0; // you may compute based on monthly salary if stored
        }else{
          amount=Number(sel);
        }
        const priority=$('#penaltyPriority').value||'Med';

        const rec={ id:uuid(), staffId:pendingPenaltyCtx.staffId, leaveId:pendingPenaltyCtx.leaveId,
          amount, priority, appliedAt:new Date().toISOString() };
        await storagePut('penalties', rec);

        // mark breach/penalty on leave
        const leaves=await storageGetAll('leaves');
        const lv=leaves.find(l=>l.id===pendingPenaltyCtx.leaveId);
        if(lv){ lv.penalty=amount; lv.priority=priority; await storagePut('leaves', lv); }

        await addAudit('penalty.apply', `Penalty ${amount} (${priority})`, null, rec);

        if(getAutoWA()){
          const staff=(await storageGetAll('staff')).find(s=>s.id===pendingPenaltyCtx.staffId);
          try{
            const url = waLink(BOSS_E164,
              ` PENALTY APPLIED\n ${staff?.name||'Staff'}\n Amount: ${amount}\n Priority: ${priority}\n Reason: Promise not honored`);
            window.open(url,'_blank');
          }catch(_){}
        }

        pendingPenaltyCtx=null;
        closeModal('modalPenalty');
        closeModal('modalReturnIn');
        refreshAll();
      }
      $('#btnPenaltySave')?.addEventListener('click', penaltySave);
      // ========================= ENTRY HELPERS =========================
      async function renderEntryStaffSelects(){
        const staff=await storageGetAll('staff');
        const opts = ['<option value="">Select staff</option>'].concat(
          staff.map(s=> `<option value="${s.id}">${s.name} — ${s.role||'—'} (${s.mobile||'-'})</option>`)
        ).join('');
        const sel1=$('#fStaff'); if(sel1) sel1.innerHTML=opts;
        const sel2=$('#graphStaffSelect'); if(sel2) sel2.innerHTML=['<option value="">(All)</option>'].concat(
          staff.map(s=> `<option value="${s.id}">${s.name}</option>`)
        ).join('');
        const selFilter=$('#filterStaff'); if(selFilter) selFilter.innerHTML=['<option value="">All staff</option>'].concat(
          staff.map(s=> `<option value="${s.id}">${s.name}</option>`)
        ).join('');
      }

      function fillFormDefaults(){
        const d=$('#fDate'); if(d && !d.value) d.value=todayStr();
        const a=$('#fAttendance'); const w=$('#lateTimeWrap');
        if(a && w) w.style.display = (a.value==='Late')?'block':'none';
      }
      $('#fAttendance')?.addEventListener('change', fillFormDefaults);

      async function renderEntryFilters(){
        const fd=$('#filterDate'); if(fd && !fd.value) fd.value='';
      }

      async function renderEntriesTable(){
        const tbody=$('#entriesTable tbody');
        const entries=await storageGetAll('entries');
        const staff=await storageGetAll('staff');
        const mapStaff = Object.fromEntries(staff.map(s=>[s.id,s]));

        const fd=$('#filterDate')?.value||'';
        const fs=$('#filterStaff')?.value||'';

        let rows = entries.slice().sort((a,b)=> b.dateISO.localeCompare(a.dateISO));
        if(fd) rows = rows.filter(r=> r.dateISO.startsWith(fd));
        if(fs) rows = rows.filter(r=> r.staffId===fs);

        tbody.innerHTML = rows.map(r=>{
          const s=mapStaff[r.staffId];
          const prom = r.promise ? `${r.promise.kind} (${r.promise.weight})` : '-';
          return `<tr>
            <td>${r.dateISO}</td>
            <td>${s? s.name : '-'}</td>
            <td>${r.attendance}${r.lateTime?` (${r.lateTime})`:''}</td>
            <td>${Number(r.advance||0)}</td>
            <td>${Number(r.penalty||0)}</td>
            <td>${prom}</td>
            <td>${r.perm||'-'}</td>
            <td class="toolbar">
              <button class="btn ghost mini" onclick="deleteEntry('${r.id}')">Delete</button>
            </td>
          </tr>`;
        }).join('') || '<tr><td colspan="8" class="muted">No entries yet.</td></tr>';
      }

      async function deleteEntry(id){
        const rows=await storageGetAll('entries');
        const cur=rows.find(x=>x.id===id);
        if(!cur) return;
        if(confirm('Delete this entry?')){
          await storageDel('entries', id);
          await addAudit('entry.delete', `Deleted entry ${id}`, cur, null);
          renderEntriesTable(); renderDashboardStats();
        }
      }

      // Save / Notify actions
      async function entryGather(){
        const dateISO = $('#fDate').value || todayStr();
        const staffId = $('#fStaff').value || '';
        const attendance = $('#fAttendance').value;
        const lateTime = (attendance==='Late') ? ($('#fLateTime').value||'') : '';
        const advance = Number($('#fAdvance').value||0);
        const penalty = Number($('#fPenalty').value||0);
        const penaltyReason = ($('#fPenaltyReason').value||'').trim();
        const perm = $('#fPerm').value || 'No';
        const note = ($('#fNote').value||'').trim();

        if(!staffId){ alert('Please select staff.'); return null; }
        if(penalty>0 && !penaltyReason){ alert('Penalty reason is required.'); return null; }

        const [weight, kind] = ($('#fPromise').value||'').split('|'); // "3|By Talk"
        const rec = {
          id:uuid(), staffId, dateISO, attendance, lateTime,
          advance, penalty, penaltyReason, perm, note,
          promise: { weight:Number(weight||0), kind:kind||'' }
        };
        return rec;
      }

      function formatWAEntry(rec, staff){
        const lines=[
          ` ENTRY`,
          ` ${staff?.name||'Staff'} (${staff?.role||'-'})`,
          ` ${rec.dateISO}   ${rec.lateTime||'-'}`,
          ` Attendance: ${rec.attendance}`,
          ` Advance: ${rec.advance}    Penalty: ${rec.penalty}`,
          ` Promise: ${rec.promise?.kind||'-'} (${rec.promise?.weight||0})`,
          ` Reason: ${rec.penalty? (rec.penaltyReason||'-'):'-'}`,
          ` Permission: ${rec.perm}`,
          ` Note: ${rec.note||'-'}`
        ];
        return lines.join('\n');
      }

      async function saveEntryCore(rec, notify=false){
        await storagePut('entries', rec);
        await addAudit('entry.save', 'Saved entry '+rec.id, null, rec);
        await renderEntriesTable(); await renderDashboardStats();
        if(notify){
          const staff=(await storageGetAll('staff')).find(s=>s.id===rec.staffId);
          try{ window.open(waLink(BOSS_E164, formatWAEntry(rec, staff)), '_blank'); }catch(_){}
        }
      }

      $('#btnSave')?.addEventListener('click', async ()=>{
        const rec=await entryGather(); if(!rec) return;
        await saveEntryCore(rec,false); alert('Saved.');
      });
      $('#btnSaveNotify')?.addEventListener('click', async ()=>{
        const rec=await entryGather(); if(!rec) return;
        await saveEntryCore(rec,true);
      });
      $('#btnNotifyOnly')?.addEventListener('click', async ()=>{
        const rec=await entryGather(); if(!rec) return;
        const staff=(await storageGetAll('staff')).find(s=>s.id===rec.staffId);
        try{ window.open(waLink(BOSS_E164, formatWAEntry(rec, staff)), '_blank'); }catch(_){}
      });
      $('#btnReset')?.addEventListener('click', ()=>{
        ['fLateTime','fAdvance','fPenalty','fPenaltyReason','fNote'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
        fillFormDefaults();
      });

      $('#btnClearFilters')?.addEventListener('click', ()=>{
        if($('#filterDate')) $('#filterDate').value='';
        if($('#filterStaff')) $('#filterStaff').value='';
        renderEntriesTable();
      });
      $('#filterDate')?.addEventListener('change', renderEntriesTable);
      $('#filterStaff')?.addEventListener('change', renderEntriesTable);

      // ========================= REPORTS =========================
      async function runReport(){
        const from=$('#repFrom').value||'';
        const to=$('#repTo').value||'';
        const st=$('#repStatus').value||'';
        const breach=$('#repBreach').value||'';
        const pri=$('#repPriority').value||'';
        const over=$('#repOverdue').checked;

        const staff=await storageGetAll('staff');
        const mapStaff=Object.fromEntries(staff.map(s=>[s.id,s]));
        let leaves=await storageGetAll('leaves');

        if(from) leaves = leaves.filter(l=> (l.promisedReturnDate||'') >= from);
        if(to) leaves = leaves.filter(l=> (l.promisedReturnDate||'') <= to);
        if(st) leaves = leaves.filter(l=>{
          const person=mapStaff[l.staffId];
          return st==='Active' ? person?.status==='Active' : (person?.status==='OnLeave');
        });
        if(breach) leaves = leaves.filter(l=> (l.breach||'')===breach);
        if(pri) leaves = leaves.filter(l=> (l.priority||'')===pri);
        if(over){ // promised date passed & not returned
          const today = new Date(todayStr());
          leaves = leaves.filter(l=> !l.returnedAt && new Date(l.promisedReturnDate) < today);
        }

        const tbody=$('#reportTable tbody');
        tbody.innerHTML = leaves.sort((a,b)=>(a.promisedReturnDate||'').localeCompare(b.promisedReturnDate||''))
          .map(l=>{
            const s=mapStaff[l.staffId];
            return `<tr>
              <td>${s?.name||'-'}</td><td>${s?.role||'-'}</td><td>${s?.mobile||'-'}</td>
              <td>${s?.status||'-'}</td>
              <td>${l.leaveStartAt? new Date(l.leaveStartAt).toLocaleString('en-IN'):'-'}</td>
              <td>${l.promisedReturnDate||'-'}</td>
              <td>${l.returnedAt? new Date(l.returnedAt).toLocaleString('en-IN'):'-'}</td>
              <td>${l.breach||'-'}</td>
              <td>${l.penalty||0}</td>
              <td>${l.priority||'-'}</td>
            </tr>`;
          }).join('') || '<tr><td colspan="10" class="muted">No matching records.</td></tr>';
      }
      $('#btnRunReport')?.addEventListener('click', runReport);

      // Export CSV (from report table)
      $('#btnExportCSV')?.addEventListener('click', ()=>{
        const rows=[['Name','Role','Mobile','Status','LeaveStartAt','PromisedReturnDate','ReturnedAt','PromiseBreach','PenaltyAmount','Priority']];
        document.querySelectorAll('#reportTable tbody tr').forEach(tr=>{
          const cols=[...tr.children].map(td=> td.textContent.replace(/\s+/g,' ').trim());
          if(cols.length) rows.push(cols);
        });
        const csv = rows.map(r=> r.map(v=> `"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv],{type:'text/csv'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='report.csv'; a.click();
        URL.revokeObjectURL(a.href);
      });

      // ========================= DASHBOARD STATS =========================
      async function renderDashboardStats(){
        const staff=await storageGetAll('staff');
        const entries=await storageGetAll('entries');
        const today=todayStr();
        const todays = entries.filter(e=> e.dateISO===today);

        const P = todays.filter(e=> e.attendance==='Present').length;
        const A = todays.filter(e=> e.attendance==='Absent').length;
        const L = todays.filter(e=> e.attendance==='Late').length;
        $('#statAttendance').textContent = `${P} P / ${A} A / ${L} L`;

        const onLeave = staff.filter(s=> s.status==='OnLeave').length;
        $('#statOnLeave').textContent = onLeave;

        // Overdue = promised date < today && not returned
        const leaves=await storageGetAll('leaves');
        const todayDate=new Date(today);
        const overdue = leaves.filter(l=> !l.returnedAt && l.promisedReturnDate && new Date(l.promisedReturnDate) < todayDate).length;
        $('#statOverdue').textContent = overdue;

        // Penalties today
        const pens=await storageGetAll('penalties');
        const todayPens = pens.filter(p=> (p.appliedAt||'').startsWith(today));
        $('#statPenalties').textContent = sum(todayPens.map(p=>p.amount));
      }

      // ========================= CHART =========================
      let chart;
      async function renderGraphStaffSelect(){
        // render on change too
        $('#graphStaffSelect')?.addEventListener('change', renderChart);
        await renderChart();
      }
      async function renderChart(){
        const ctx=document.getElementById('trackChart');
        if(!ctx) return;
        const entries=await storageGetAll('entries');
        const fs=$('#graphStaffSelect').value||'';

        const last30 = entries.filter(e=> !fs || e.staffId===fs)
          .sort((a,b)=> a.dateISO.localeCompare(b.dateISO))
          .slice(-60); // up to last 60 entries

        const labels = last30.map(e=> e.dateISO);
        const adv = last30.map(e=> Number(e.advance||0));
        const pen = last30.map(e=> Number(e.penalty||0));

        if(chart) chart.destroy();
        chart = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets:[
            { label:'Advance ()', data:adv },
            { label:'Penalty ()', data:pen }
          ]},
          options:{ responsive:true, maintainAspectRatio:false }
        });
      }

      // ========================= AUDIT =========================
      async function renderAudit(){
        const log=$('#auditLog'); if(!log) return;
        const items=await storageGetAll('audits');
        items.sort((a,b)=> new Date(b.ts)-new Date(a.ts));
        log.innerHTML = items.slice(0,200).map(a=>{
          return `<div><b>${a.type}</b> — <span class="muted">${new Date(a.ts).toLocaleString('en-IN')}</span><br>${a.detail||''}</div>`;
        }).join('');
      }
      // ========================= SETTINGS: EXPORT / IMPORT / SESSION =========================
      async function exportBackup(){
        const payload = {
          when: new Date().toISOString(),
          staff: await storageGetAll('staff'),
          entries: await storageGetAll('entries'),
          leaves: await storageGetAll('leaves'),
          penalties: await storageGetAll('penalties'),
          audits: await storageGetAll('audits')
        };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=`az_staff_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      }
      async function importMerge(file){
        const text = await file.text();
        const data = JSON.parse(text||'{}');
        for(const s of (data.staff||[]))      await storagePut('staff', s);
        for(const e of (data.entries||[]))    await storagePut('entries', e);
        for(const l of (data.leaves||[]))     await storagePut('leaves', l);
        for(const p of (data.penalties||[]))  await storagePut('penalties', p);
        for(const a of (data.audits||[]))     await storagePut('audits', a);
        await addAudit('backup.import', `Imported backup with ${ (data.staff||[]).length } staff`);
        await refreshAll();
        alert('Import & merge completed.');
      }

      // ========================= TABS & CONTROLS =========================
      $$('.tabBtn').forEach(btn=>{
        btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab));
      });

      $('#btnExport')?.addEventListener('click', exportBackup);
      $('#btnImport')?.addEventListener('click', ()=>{
        const f=$('#fileImport');
        if(!f || !f.files || !f.files[0]){ alert('Choose a .json file first.'); return; }
        importMerge(f.files[0]);
      });
      $('#btnForceLogout')?.addEventListener('click', ()=>{
        setLogged(false);
        try{
          document.querySelectorAll('.tabs button').forEach(b=> b.disabled=true);
          $('#loginStatus').textContent='';
        }catch(e){}
        const gate=$('#loginGate'); if(gate) gate.classList.remove('hidden');
        setActiveTab('dashboard');
      });

      // Staff Master actions
      $('#staffSearch')?.addEventListener('input', renderStaffTable);
      $('#btnAddStaff')?.addEventListener('click', async ()=>{
        const name = prompt('Staff Name'); if(!name) return;
        const role = prompt('Role (Driver/Worker/Other)') || '';
        let mobileRaw = prompt('Mobile (+91XXXXXXXXXX)') || '';
        try{
          const mobile = sanitizeMobile(mobileRaw);
          if(await checkDuplicateMobile(mobile)) return;
          const s={id:uuid(), name, role, mobile, status:'Active'};
          await storagePut('staff', s);
          await addAudit('staff.create', 'Added '+name, null, s);
          await refreshAll();
        }catch(e){ alert(e.message); }
      });

      // Auto WA toggle
      $('#autoWA')?.addEventListener('change', e=> setAutoWA(!!e.target.checked));

      // Modal buttons already wired in previous parts:
      // - #btnLeaveSave (leaveSave)
      // - #btnReturnSave (returnSave)
      // - #btnPenaltySave (penaltySave)

      // ========================= INIT =========================
      (async function init(){
        // Year in footer
        const y=$('#yearNow'); if(y) y.textContent = new Date().getFullYear();

        // Open IndexedDB (fallback to localStorage if blocked)
        try{ db = await idbOpen(); }catch(e){ db=null; console.warn('IDB disabled, using localStorage'); }

        // Seed demo data if empty
        await seedIfNeeded();

        // Restore Settings
        setAutoWA(getAutoWA());

        // Session state
        const logged = isLogged();
        if(logged){
          // enable tabs & hide login
          try{ document.querySelectorAll('.tabs button').forEach(b=> b.disabled=false); }catch(e){}
          const gate=$('#loginGate'); if(gate) gate.classList.add('hidden');
          const s=$('#loginStatus'); if(s) s.textContent='Admin: Logged in';
        }else{
          try{ document.querySelectorAll('.tabs button').forEach(b=> b.disabled=true); }catch(e){}
          const gate=$('#loginGate'); if(gate) gate.classList.remove('hidden');
          const s=$('#loginStatus'); if(s) s.textContent='';
        }

        // Defaults
        fillFormDefaults();

        // First render
        await refreshAll();

        // Default tab
        setActiveTab('dashboard');
      })();
    </script>
  </main>
</body>
</html>